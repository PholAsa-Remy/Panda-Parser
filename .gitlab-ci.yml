# CI - CD
# Voir aussi :
#   - https://gradle.org/
#   - https://github.com/gradle/gradle
#   - https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Gradle.gitlab-ci.yml

# inclure les variables et les modèles
include:
  - local: .gitlab-ci-variables.yml
  - local: pipeline-template/.generate-binaries-tempalte.yml

# gradle Image - par default
image: gradle:alpine

# Les stages à exécuter
stages:
  - build
  - test
  - binaries
  - release

# export env variables
before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

# build job - compilation de projet
build:
  stage: build
  script:
    - gradle --build-cache assemble
  artifacts:
    paths:
      - build

# test job - verifier si tous les tests sont bien passés
test:
  stage: test
  script: gradle check
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - build
      - .gradle

linux-macOS-binary:
  stage: binaries
  extends: .generate-binaries-tempalte
  variables:
    BINARIES_DIR: "linux-macOS-binary"
    SCRIPT_NAME: $APP_NAME
  artifacts:
    paths:
      - $BINARIES_DIR